
https://www.jianshu.com/p/9c7e1c957752

# 1. 环境准备安装

Centos7.3+ 建议升级，使用yum update更新到最新版本

| 主机名称 | IP |
|---------|----|
|master1|10.12.1.20|
|node1|10.12.1.21|
|node2|10.12.2.22|

```
timedatectl set-timezone Asia/Shanghai  #都要执行
hostnamectl set-hostname master1   #master1执行
hostnamectl set-hostname node1    #node1执行
hostnamectl set-hostname node2    #node2执行
```

```
10.12.1.20 master1
10.12.1.21 node1
10.12.1.22 node2
```

```
sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
setenforce 0
systemctl disable firewalld
systemctl stop firewalld
```

# 2. 安装docker(所有节点)

```
tar -xvf docker-packages.tar
cd docker-packages
rpm -Uvh * 或者 yum install local *.rpm  进行安装
docker version        #安装完成查看版本
```

```
systemctl start docker && systemctl enable docker
```


```
cat << EOF > /etc/docker/daemon.json
{
  "exec-opts": ["native.cgroupdriver=cgroupfs"]
}
EOF
systemctl daemon-reload && systemctl restart docker
```

# 3. 安装kubeadm，kubectl，kubelet（所有节点）

```
tar -xvf kube-packages-1.10.1.tar
cd kube-packages-1.10.1
rpm -Uvh * 或者 yum install local *.rpm  进行安装
```


```
# 默认kubelet使用的cgroup-driver=systemd，改为cgroup-driver=cgroupfs
sed -i "s/cgroup-driver=systemd/cgroup-driver=cgroupfs/g" /etc/systemd/system/kubelet.service.d/10-kubeadm.conf

# 重设kubelet服务，并重启kubelet服务
systemctl daemon-reload && systemctl restart kubelet

# 关闭swap
swapoff -a
vi /etc/fstab   #swap一行注释
```


```
cat <<EOF >  /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sysctl --system
```

# 4. 导入镜像(全部)

```
docker load -i k8s-images-1.10.tar.gz 
```

# 5.  kubeadm init 部署master节点（Master节点）
```
kubeadm init --kubernetes-version=v1.10.1 --pod-network-cidr=10.244.0.0/16
```


```
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

```
echo "export KUBECONFIG=/etc/kubernetes/admin.conf" >> /etc/profile
source /etc/profile
echo $KUBECONFIG    #应该返回/etc/kubernetes/admin.conf
```

# 6. 部署flannel网络 (master节点)

```
kubectl apply -f kube-flannel.yml
```


# 7. node加入集群（node节点）

```
kubeadm join 10.12.1.20:6443 --token 70h9oe.psi211ihvrlfy1wo --discovery-token-ca-cert-hash sha256:a1ed105cc6712b2742c1d8228f047fb140c2b0a8f8671595fe330af2d9f18d79
```

## 如果忘记token
```
[root@master1 kubernetes1.10]# kubeadm token list
TOKEN                     TTL       EXPIRES                     USAGES                   DESCRIPTION                                                EXTRA GROUPS
wct45y.tq23fogetd7rp3ck   22h       2018-04-26T21:38:57+08:00   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token
```
然后再替换下面的token即可

```
kubeadm join --token wct45y.tq23fogetd7rp3ck 192.168.1.181:6443 --discovery-token-unsafe-skip-ca-verification
```



## node flannel
sudo docker pull flannel:v0.10.0-amd64
sudo docker tag flannel:v0.10.0-amd64 quay.io/coreos/flannel:v0.10.0-amd64
sudo docker rmi flannel:v0.10.0-amd64

# 移除节点
```
master中：
kubectl drain node1 --delete-local-data --force --ignore-daemonsets
kubectl delete node node1
```

node2中：
```
kubeadm reset
ifconfig cni0 down
ip link delete cni0
ifconfig flannel.1 down
ip link delete flannel.1
rm -rf /var/lib/cni/
```

# 8. dashboard

```
kubectl apply -f kubernetes-dashboard-http.yaml
kubectl apply -f admin-role.yaml
kubectl apply -f kubernetes-dashboard-admin.rbac.yaml

[root@master1 kubernetes1.10]# kubectl apply -f kubernetes-dashboard-http.yaml 
serviceaccount "kubernetes-dashboard" created
role.rbac.authorization.k8s.io "kubernetes-dashboard-minimal" created
rolebinding.rbac.authorization.k8s.io "kubernetes-dashboard-minimal" created
deployment.apps "kubernetes-dashboard" created
service "kubernetes-dashboard" created
[root@master1 kubernetes1.10]# kubectl apply -f admin-role.yaml 
clusterrolebinding.rbac.authorization.k8s.io "kubernetes-dashboard" created
[root@master1 kubernetes1.10]# kubectl apply -f kubernetes-dashboard-admin.rbac.yaml 
clusterrolebinding.rbac.authorization.k8s.io "dashboard-admin" created
```

# 9. kubectl 补全
```
yum install bash-completion
root@master1:/# vim /etc/profilecd   #添加下面这句，再source
source <(kubectl completion bash)
root@master1:/# source /etc/profile
```

# 10. master节点部署pod
```
kubectl taint node master1 node-role.kubernetes.io/master-
```